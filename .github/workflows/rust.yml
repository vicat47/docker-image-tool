name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šåœ¨æ‰€æœ‰å¹³å°ä¸Šè¿è¡Œæµ‹è¯•
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Run tests
        run: cargo test --verbose

      # å¯é€‰ï¼šè¿è¡Œclippyè¿›è¡Œä»£ç æ£€æŸ¥
      - name: Run clippy
        run: cargo clippy -- -D warnings

  # ç¬¬äºŒé˜¶æ®µï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆåœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡åè¿è¡Œï¼‰
  prepare:
    needs: test  # ä¾èµ–æµ‹è¯•é˜¶æ®µ
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.FULL_VERSION }}
      bin_name: ${{ steps.version.outputs.BIN_NAME }}

    steps:
      - uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          # è·å– cargo ç‰ˆæœ¬
          CARGO_VERSION=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].version')
          # è·å–çŸ­æäº¤å“ˆå¸Œ
          COMMIT_HASH=$(git rev-parse --short=8 HEAD)
          FULL_VERSION="${CARGO_VERSION}+${COMMIT_HASH}"
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $FULL_VERSION"
          
          # è·å–äºŒè¿›åˆ¶åç§°
          BIN_NAME=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].name')
          echo "BIN_NAME=$BIN_NAME" >> $GITHUB_OUTPUT
          echo "Binary name: $BIN_NAME"

  # ç¬¬ä¸‰é˜¶æ®µï¼šåœ¨æ‰€æœ‰å¹³å°ä¸Šæ„å»ºï¼ˆåœ¨æµ‹è¯•é€šè¿‡åè¿è¡Œï¼‰
  build:
    needs: [test, prepare]  # ä¾èµ–æµ‹è¯•å’Œå‡†å¤‡é˜¶æ®µ
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact_suffix: linux-x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact_suffix: windows-x86_64.exe
          - target: x86_64-apple-darwin
            os: macos-latest
            artifact_suffix: macos-x86_64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact
        run: |
          BIN_NAME="${{ needs.prepare.outputs.bin_name }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          ARTIFACT_SUFFIX="${{ matrix.artifact_suffix }}"
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows å¤„ç†
            Copy-Item "target\${{ matrix.target }}\release\${BIN_NAME}.exe" `
                      "target\${{ matrix.target }}\release\${BIN_NAME}-${VERSION}-${ARTIFACT_SUFFIX}"
          else
            # Linux/macOS å¤„ç†
            cp "target/${{ matrix.target }}/release/$BIN_NAME" \
               "target/${{ matrix.target }}/release/${BIN_NAME}-${VERSION}-${ARTIFACT_SUFFIX}"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_suffix }}
          path: |
            target/${{ matrix.target }}/release/${{ needs.prepare.outputs.bin_name }}-${{ needs.prepare.outputs.version }}-${{ matrix.artifact_suffix }}
            target/${{ matrix.target }}/release/${{ needs.prepare.outputs.bin_name }}*
          retention-days: 1

  # ç¬¬å››é˜¶æ®µï¼šåˆ›å»ºå‘å¸ƒï¼ˆåœ¨æ‰€æœ‰æ„å»ºå®Œæˆä¸”æˆåŠŸåè¿è¡Œï¼‰
  release:
    needs: [test, build]  # ä¾èµ–æµ‹è¯•å’Œæ„å»ºé˜¶æ®µ
    if: success()  # åªæœ‰å‰é¢çš„å·¥ä½œéƒ½æˆåŠŸæ‰è¿è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
          find artifacts/ -type f | sort

      - name: Get version info
        id: version
        run: |
          # è·å– cargo ç‰ˆæœ¬
          CARGO_VERSION=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].version')
          # è·å–çŸ­æäº¤å“ˆå¸Œ
          COMMIT_HASH=$(git rev-parse --short=8 HEAD)
          FULL_VERSION="${CARGO_VERSION}+${COMMIT_HASH}"
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          
          # è·å–äºŒè¿›åˆ¶åç§°
          BIN_NAME=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].name')
          echo "BIN_NAME=$BIN_NAME" >> $GITHUB_OUTPUT

      # åˆ›å»º GitHub Releaseï¼ˆé¢„å‘å¸ƒç‰ˆæœ¬ï¼‰
      - name: Create Continuous Release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨æäº¤å“ˆå¸Œä½œä¸º tag
          tag_name: "commit-${{ github.sha }}"
          name: "Build ${{ steps.version.outputs.FULL_VERSION }}"
          body: |
            ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            
            **ç‰ˆæœ¬:** ${{ steps.version.outputs.FULL_VERSION }}
            **æäº¤:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            **æ„å»ºæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ### ğŸ“¦ å¹³å°æ”¯æŒ
            
            | å¹³å° | æ–‡ä»¶å | ä¸‹è½½é“¾æ¥ |
            |------|--------|----------|
            | Linux (x86_64) | `${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-linux-x86_64` | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/commit-${{ github.sha }}/${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-linux-x86_64) |
            | Windows (x86_64) | `${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-windows-x86_64.exe` | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/commit-${{ github.sha }}/${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-windows-x86_64.exe) |
            | macOS (x86_64) | `${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-macos-x86_64` | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/download/commit-${{ github.sha }}/${{ steps.version.outputs.BIN_NAME }}-${{ steps.version.outputs.FULL_VERSION }}-macos-x86_64) |
            
            ### ğŸ”§ æ„å»ºä¿¡æ¯
            - **Cargo ç‰ˆæœ¬:** $(cargo --version)
            - **Rust ç‰ˆæœ¬:** $(rustc --version)
            - **æäº¤ä¿¡æ¯:** ${{ github.event.head_commit.message }}
            
            ---
            
            > âš ï¸ è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œç”¨äºæµ‹è¯•ç›®çš„ã€‚
            > 
            > æ‰€æœ‰æµ‹è¯•å·²é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨ã€‚
          draft: false
          prerelease: true
          generate_release_notes: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Upload Release Assets
        run: |
          # ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸Šä¼ é“¾æ¥
          for file in $(find artifacts/ -type f); do
            echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶: $(basename $file)"
            gh release upload "commit-${{ github.sha }}" "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¯é€‰çš„ï¼šæ·»åŠ ä¸€ä¸ªæ€»ç»“ä¿¡æ¯åˆ° GitHub Actions
      - name: Add summary
        if: always()
        run: |
          echo "## ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.version.outputs.FULL_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‘å¸ƒé“¾æ¥:** [https://github.com/${{ github.repository }}/releases/tag/commit-${{ github.sha }}](https://github.com/${{ github.repository }}/releases/tag/commit-${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŒ…å«çš„å¹³å°:**" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "- Windows (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (x86_64)" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰çš„ï¼šæ¸…ç†æ—§çš„é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
  cleanup:
    needs: release
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Clean up old prereleases
        run: |
          # è·å–æ‰€æœ‰é¢„å‘å¸ƒç‰ˆæœ¬
          echo "æ­£åœ¨æ£€æŸ¥æ—§çš„é¢„å‘å¸ƒç‰ˆæœ¬..."
          
          # ä¿ç•™æœ€è¿‘5ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬
          gh release list --limit 50 | grep "Pre-release" | awk '{print $1"|"$3"|"$4}' | while read line; do
            TAG=$(echo $line | cut -d'|' -f1)
            DATE=$(echo $line | cut -d'|' -f2)
            TITLE=$(echo $line | cut -d'|' -f3)
          
            # è·³è¿‡æœ€è¿‘5ä¸ª
            COUNT=$((COUNT+1))
            if [ $COUNT -le 5 ]; then
              echo "ä¿ç•™: $TAG ($DATE) - $TITLE"
              continue
            fi
          
            # åˆ é™¤æ—§çš„é¢„å‘å¸ƒç‰ˆæœ¬
            echo "åˆ é™¤: $TAG ($DATE) - $TITLE"
            gh release delete "$TAG" --yes || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}